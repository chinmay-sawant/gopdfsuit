# Optimization 6 — Walkthrough

## Changes Made

### 1. Custom Fixed-Point Float Formatter — [draw.go](internal/pdf/draw.go#L12-L44)

Replaced `strconv.AppendFloat('f', 2, 64)` with integer-math: `scaled := int64(f*100 + 0.5)`, then integer division/modulo for int/frac parts. Eliminates the `bigFtoa` → `genericFtoa` → `rightShift` → `decimal.Assign` code path (~10% CPU in pprof).

render_diffs(internal/pdf/draw.go)

---

### 2. EncodeTextForCustomFont Rewrite — [fonts.go](internal/pdf/fonts.go#L1027-L1057)

Replaced `strings.Builder` + per-char `writeHex4()` function calls with `[]byte` append using inline hex nibble encoding. Single allocation, no function call overhead.

render_diffs(internal/pdf/fonts.go)

---

### 3. drawTable GC Pressure Reduction — [draw.go](internal/pdf/draw.go#L770-L772)

- **Hoisted `scratchBuf`** above row loop — reused across all `bgColorBuf`, `textPosBuf`, `underlineBuf` allocations
- **Cached `rowResolvedFonts`** — eliminates 2-3 redundant `resolveFontName()` calls per cell in the render path

---

### 4. fmt.Sprintf Elimination — [generator.go](internal/pdf/generator.go#L524-L608)

Replaced ~8 `fmt.Sprintf` calls + string concatenation in XObject/ColorSpace resource building with `strings.Builder` + `strconv.AppendInt`.

render_diffs(internal/pdf/generator.go)

---

## Verification

| Check                          | Result  |
| :----------------------------- | :------ |
| `go build ./...`               | ✅ Pass |
| `TestLiberationSansCompliance` | ✅ Pass |
| `TestTitleVisibility`          | ✅ Pass |
| `TestXFDFFillSample`           | ✅ Pass |

### Benchmark (5 runs, `-benchmem`)

```
BenchmarkGoPdfSuit-24    45    25,592,494 ns/op    17,613,514 B/op    302,691 allocs/op
BenchmarkGoPdfSuit-24    46    26,957,150 ns/op    17,558,420 B/op    302,691 allocs/op
BenchmarkGoPdfSuit-24    45    25,603,188 ns/op    17,612,962 B/op    302,690 allocs/op
BenchmarkGoPdfSuit-24    39    26,031,507 ns/op    17,595,707 B/op    302,689 allocs/op
BenchmarkGoPdfSuit-24    44    26,967,057 ns/op    17,615,433 B/op    302,691 allocs/op
```

**Avg: ~26.2ms/op, ~17.6MB/op, ~302,690 allocs/op**
