# 1.24 Optimization Summary & Final Report (14_02_Optimization)

This document summarizes the comprehensive optimization journey undertaken in the `14_02_Optimization` folder to enhance the performance of `gopdfsuit` running on Go 1.24. It aggregates all changes from the initial optimization pass through Optimization 6, followed by the final "Zerodha Gold Standard" benchmark results.

## Cumulative Optimizations (v1 - v6)

### 1. Server Application Tuning

- **Minimal Middleware:** Switched from `gin.Default()` to `gin.New()`, removing the default Logger middleware which caused significant lock contention on stdout.
- **Release Mode:** Enforced `gin.SetMode(gin.ReleaseMode)` to disable debug logging and overhead.
- **Concurrency Tuning:** Adjusted concurrency semaphores (tested at 100 and mapped to CPU cores) to optimize throughput.
- **Timeouts:** Configured aggressive `ReadTimeout` and `WriteTimeout` for resource protection.

### 2. Memory & Allocation Management

- **Buffer Pooling:** Implemented `sync.Pool` for main PDF buffers and scratch buffers, drastically reducing heap allocations and GC pressure.
- **Zero-Copy Logic:** Optimized response handling to copy data only once to a final slice before returning buffers to the pool.
- **Allocation Hoisting:** Moved heavy allocations (e.g., `cellWidths`, `wrappedTextLines`, `cellProps`, `IsCustomFont` maps) out of hot loops (like `drawTable`) to be reused or pre-allocated.
- **Pre-sizing:** Pre-sized maps (e.g., `UsedChars`) and slices to prevent expensive resizing and rehashing during execution.

### 3. CPU Hotpath Optimization

- **Sprintf Elimination:** Replaced expensive `fmt.Sprintf` calls with `strconv.AppendInt`, hex lookup tables, and manual byte appending in critical paths (XRef table generation, PDF object formatting).
- **Incremental Hashing:** Switched to incremental `md5.New()` hashing to avoid copying entire buffers.
- **Font Scanning Optimization:** Eliminated separate "scan for font usage" passes. Integrated `MarkCharsUsed` directly into the drawing methods to collect usage data during content generation ("Single Pass").
- **Refactored Text Wrapping:** Optimized `EstimateTextWidth` and `WrapText` to use pre-resolved font names and efficient rune counting.

### 4. Font System Architecture

- **Lock-Free Registry:** Introduced a `noLock` mode for `CustomFontRegistry`. Per-request clones now bypass mutex locking entirely, removing synchronization overhead in the hottest paths.
- **Reference Caching:** Pre-computed and cached PDF font references (e.g., `/CF1`) in `RegisteredFont` objects to avoid repeated formatting.
- **Deferred Subsetting:** Moved font subset generation to the very end of the process, ensuring it runs only once per request.
- **Zlib Pooling:** Implemented pooling for `zlib.Writer` to reuse compression states and avoid initialization overhead for font streams.

---

## Performance Evolution

### 1. GoPdfLib (Raw Library) Benchmarks

_Comparison of the raw library performance from the start of the day (Morning) to the final optimized version (v6)._

| Metric          | Morning Build (Baseline) | Optimization 6 (Final)  | Improvement             |
| :-------------- | :----------------------- | :---------------------- | :---------------------- |
| **Throughput**  | 514.80 ops/sec           | **1,741.47 ops/sec**    | **+238% (3.4x Faster)** |
| **Avg Latency** | 90.25 ms                 | **27.05 ms**            | **-70.0% (Faster)**     |
| **Workload**    | Zerodha Gold (5k iters)  | Zerodha Gold (5k iters) | -                       |

> **Note:** The raw library performance has more than tripled, proving that the core PDF generation logic is now extremely efficient.

### 2. GoPdfSuit (API) Benchmarks

_Comparison of the API server performance, including network and HTTP overhead (k6 Spike Test - 100 VUs)._

| Metric          | v1.24 Optimized (Baseline) | v1.24 Optimization 6 (Final) | Improvement         |
| :-------------- | :------------------------- | :--------------------------- | :------------------ |
| **Throughput**  | 78.64 req/s                | **82.79 req/s**              | +5.3%               |
| **Avg Latency** | 35.39 ms                   | **10.67 ms**                 | **-69.8% (Faster)** |
| **p95 Latency** | 324.49 ms                  | **73.77 ms**                 | **-77.3% (Faster)** |
| **p99 Latency** | 575.54 ms                  | **115.99 ms**                | **-79.8% (Faster)** |

> **Conclusion:** The API optimizations have drastically smoothed out the latency curve. While throughput gains are modest (likely hit a test-client or network bottleneck), the **p99 latency dropped by ~80%**, meaning the server is vastly more stable and responsive under heavy load.

---

## Final Performance Benchmark: Zerodha Gold Standard (v6)

**Workload:** 80% Retail (Small), 15% Active (Medium), 5% HFT (Large)  
**Environment:** Linux, amd64, 24 CPUs, Go 1.24.0  
**Concurrency:** 48 Workers

```text
=== Zerodha Gold Standard Benchmark ===
Workload Mix: 80% Retail | 15% Active | 5% HFT

OS: linux, Arch: amd64, NumCPU: 24, GoVersion: go1.24.0
Running 5000 iterations using 48 workers...

Building templates...
Templates built.
Warm-up runs...
  Retail PDF size:  61247 bytes (59.81 KB)
  Active PDF size:  76012 bytes (74.23 KB)
  HFT PDF size:     2425705 bytes (2368.85 KB)

  Max Memory Allocated: 1017.61 MB
=== Performance Summary ===
  Iterations:      5000
  Concurrency:     48 workers
  Total time:      2.871 s
  Throughput:      1741.47 ops/sec

  Avg Latency:     27.048 ms
  Min Latency:     2.125 ms
  Max Latency:     707.855 ms

=== Workload Distribution ===
  Retail  (80%):   4013 iterations
  Active  (15%):   746 iterations
  HFT      (5%):   241 iterations

Saved: zerodha_retail_output.pdf (61247 bytes)
Saved: zerodha_active_output.pdf (76012 bytes)
Saved: zerodha_hft_output.pdf (2425705 bytes)

=== Done ===
```
