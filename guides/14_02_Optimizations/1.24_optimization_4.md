# Benchmark Comparison - 1.24 Optimization 4 vs 1.24 Optimization 3 vs 1.24 Optimized

This report compares the performance results of the **GoPdfSuit** API running on Go 1.24 (Optimization 4) against the previous optimization baseline (Optimization 3) and Go 1.24.

## Test Environment

- **Current Version:** Go 1.24 (Optimization 4 - Draw Loop & Font Scan Optimization)
- **Previous Version:** Go 1.24 (Optimization 3)
- **Baseline Version:** Go 1.24 (Optimized)
- **Date:** 2026-02-14

## Optimization Details (v1.24 Opt 4)

1. **Rendering Loop Optimization**:
   - Hoisted memory allocations (`cellWidths`, `wrappedTextLines`, `cellProps`) out of the `drawTable` row loop to reduce GC pressure.
   - Cached parsed cell properties to avoid redundant parsing in the second pass.
   - Refactored `EstimateTextWidth` and `WrapText` to use pre-resolved font names and `utf8.RuneCountInString`, avoiding redundant font lookups and rune slice allocations.

2. **Font Subsetting Optimization**:
   - Eliminated the separate `scanTemplateForFontUsage` pass over the template data.
   - Integrated `MarkCharsUsed` directly into the drawing methods (`drawTable`, `drawTitle`, `drawFooter`), collecting usage data during content generation.
   - Deferred `GenerateSubsets` until after content generation, ensuring all used characters are captured without a dedicated scan pass.

## Benchmark Results Comparison

### 1. General Performance

| Test Scenario             | Total Req | Throughput (req/s) | Avg Latency | p95 Latency | p99 Latency  |
| :------------------------ | :-------- | :----------------- | :---------- | :---------- | :----------- |
| **Spike - 100 VU (1.24)** | 7,891     | 78.64              | 35.39ms     | 324.49ms    | 575.54ms     |
| **Spike - 100 VU (Opt3)** | 7,831     | 78.15              | 38.77ms     | 364.19ms    | 738.94ms     |
| **Spike - 100 VU (Opt4)** | **8,017** | **79.88**          | **27.72ms** | **44.48ms** | **479.95ms** |

### 2. Delta Analysis (Spike Test vs Opt 3)

| Metric          | v1.24 (Optimization 3) | v1.24 (Optimization 4) | Change              |
| :-------------- | :--------------------- | :--------------------- | :------------------ |
| **Throughput**  | 78.15 req/s            | 79.88 req/s            | +2.2% (Better)      |
| **Avg Latency** | 38.77ms                | 27.72ms                | **-28.5% (Faster)** |
| **p95 Latency** | 364.19ms               | 44.48ms                | **-87.8% (Faster)** |
| **p99 Latency** | 738.94ms               | 479.95ms               | **-35.0% (Faster)** |

## Observations

- **Massive Reduction in p95 Latency:** The most significant improvement is in the p95 latency, which dropped by **87.8%** (from 364ms to 44ms). This indicates that the optimizations successfully eliminated the "convoy effect" or resource contention that was causing high tail latency under load.
- **Throughput Increase:** The throughput has surpassed both the previous optimization and the Go 1.24 baseline, reaching essentially 80 req/s.
- **Memory Efficiency:** The changes to remove the initial font scan and hoist allocations likely reduced GC pauses, contributing to the smoother latency distribution.

> **Conclusion:** Optimization 4 successfully resolved the regression observed in Optimization 3 and significantly outperformed the Go 1.24 baseline. The removal of the redundant font usage scan and the optimization of the inner rendering loops were highly effective.
