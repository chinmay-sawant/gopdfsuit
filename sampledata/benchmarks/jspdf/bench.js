const { jsPDF } = require("jspdf");
const fs = require('fs');
const { performance } = require('perf_hooks');

const data = JSON.parse(fs.readFileSync('../data.json', 'utf8'));

const start = performance.now();

// Attempt to load autoTable
let autoTable = null;
try {
    autoTable = require('jspdf-autotable');
} catch (e) {
    console.log("Could not load jspdf-autotable");
}

const doc = new jsPDF();

doc.text("User Report", 14, 20);

const body = data.map(record => [
    String(record.id),
    record.name,
    record.email,
    record.role,
    record.desc
]);

if (doc.autoTable) {
    // If attached automatically
    doc.autoTable({
        startY: 25,
        head: [['ID', 'Name', 'Email', 'Role', 'Description']],
        body: body,
    });
} else if (autoTable) {
    // Try to call it directly if it's a function
    if (typeof autoTable === 'function') {
        try {
            autoTable(doc, {
                startY: 25,
                head: [['ID', 'Name', 'Email', 'Role', 'Description']],
                body: body,
            });
        } catch (e) {
            // Maybe it's the module object with a default?
            if (autoTable.default && typeof autoTable.default === 'function') {
                autoTable.default(doc, {
                    startY: 25,
                    head: [['ID', 'Name', 'Email', 'Role', 'Description']],
                    body: body,
                });
            } else {
                console.log("autoTable function usage failed, falling back to text");
                drawTextFallback(doc);
            }
        }
    } else {
        console.log("autoTable is not a function, falling back to text");
        drawTextFallback(doc);
    }
} else {
    drawTextFallback(doc);
}

function drawTextFallback(doc) {
    let y = 30;
    const pageHeight = doc.internal.pageSize.height;

    doc.setFontSize(10);
    for (const r of data) {
        if (y > pageHeight - 20) {
            doc.addPage();
            y = 20;
        }
        const text = `${r.id} | ${r.name} | ${r.email} | ${r.role}`;
        doc.text(text, 14, y);
        y += 10;
    }
}

if (doc.lastAutoTable) {
    doc.text("Generated by jsPDF", 14, doc.lastAutoTable.finalY + 10);
} else {
    doc.text("Generated by jsPDF", 14, doc.lastAutoTable ? doc.lastAutoTable.finalY + 10 : 200); // approximate
}

const pdfOutput = doc.output('arraybuffer');
fs.writeFileSync('output_jspdf.pdf', Buffer.from(pdfOutput));

const end = performance.now();
console.log(`jsPDF Time: ${(end - start).toFixed(2)} ms`);
